<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercise Tracker</title>
    <style>
        /* UI STYLES */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', Monaco, monospace; background: white; color: black; padding: 20px; line-height: 1.6; font-size: 12px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; }
        h1 { text-align: center; margin-bottom: 20px; font-weight: normal; }
        .section { margin-bottom: 30px; }
        .section-title { margin-bottom: 15px; text-decoration: underline; }
        .input-row { margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 5px; align-items: center; }
        input[type="text"], input[type="number"], input[type="date"], textarea, select { font-family: 'Courier New', Monaco, monospace; border: 1px solid black; padding: 4px; margin-right: 5px; font-size: 12px; }
        textarea { width: 100%; min-height: 40px; resize: vertical; margin-top: 5px; }
        button { font-family: 'Courier New', Monaco, monospace; border: 1px solid black; background: white; padding: 4px 8px; cursor: pointer; font-size: 12px; }
        button:hover { background: #f0f0f0; }
        .exercise-list { margin-top: 15px; border: 1px solid black; padding: 10px; min-height: 200px; }
        .exercise-entry { margin-bottom: 15px; border-bottom: 1px dotted black; padding-bottom: 10px; }
        .exercise-main { display: flex; align-items: center; margin-bottom: 5px; }
        .exercise-text { flex: 1; font-family: 'Courier New', Monaco, monospace; }
        .exercise-notes { margin-left: 20px; font-style: italic; color: #555; margin-bottom: 5px; }
        .delete-btn { padding: 2px 6px; font-size: 10px; margin-left: 10px; }
        .summary { border: 2px solid black; padding: 15px; margin-top: 30px; }
        .summary-subtitle { font-weight: bold; margin-bottom: 10px; text-decoration: underline; }
        .summary-line { margin-bottom: 3px; font-size: 11px; }
        .buttons { text-align: center; margin-top: 15px; }
        .buttons button { margin: 0 5px; }
        .exercise-type-manager { margin-bottom: 15px; border: 1px solid black; padding: 10px; }
        .exercise-type-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; padding: 2px 5px; }

        /* HEATMAP STYLES */
        .heatmap-year-label { font-weight: bold; margin-top: 15px; margin-bottom: 5px; text-decoration: underline; }
        .heatmap-grid { display: grid; grid-template-columns: repeat(31, 1fr); gap: 2px; border: 1px solid black; padding: 5px; margin-bottom: 10px; }
        .heatmap-cell { width: 10px; height: 10px; border-radius: 2px; border: 1px solid #e5e7eb; }
        .level-0 { background-color: #ffffff; }
        .level-1 { background-color: #d1d5db; }
        .level-2 { background-color: #9ca3af; }
        .level-3 { background-color: #6b7280; }
        .level-4 { background-color: #000000; }

        /* STATELESS OVERLAY */
        .drop-zone { border: 2px dashed black; padding: 40px; text-align: center; margin-bottom: 10px; background: #f9f9f9; cursor: pointer; font-weight: bold; }
        .hidden { display: none !important; }

        /* PRINT HIDING */
        @media print {
            .drop-zone, .exercise-type-manager, .buttons, .section:has(.input-row), h1 { display: none !important; }
            .container { max-width: 100%; padding: 0; }
            .heatmap-cell { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Exercise Tracker</h1>

        <div id="uploadPrompt" class="drop-zone">
            <div onclick="document.getElementById('csvFileInput').click()">TAP TO IMPORT EXERCISES.CSV</div>
            <div style="margin-top: 15px; font-weight: normal; border-top: 1px solid #ccc; padding-top: 10px;">
                <button onclick="tracker.startFresh()">Or Start Fresh Session</button>
            </div>
        </div>

        <div id="mainApp" class="hidden">
            <div class="section">
                <h2 class="section-title">Add Exercise</h2>
                <div class="input-row">
                    <input type="date" id="exerciseDate">
                    <select id="exerciseTypeSelect"></select>
                    <input type="number" id="exerciseDuration" placeholder="Minutes">
                    <button onclick="tracker.addExercise()">Add</button>
                </div>
                <textarea id="exerciseNotes" placeholder="Notes (optional)"></textarea>
            </div>

            <div class="section">
                <h2 class="section-title">Exercise Types</h2>
                <div class="exercise-type-manager">
                    <div class="input-row">
                        <input type="text" id="newExerciseType" placeholder="New type...">
                        <button onclick="tracker.addExerciseType()">Add Type</button>
                    </div>
                    <div id="exerciseTypeList"></div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Summary & History Heatmaps</h2>
                <div class="summary">
                    <div id="summaryContent"></div>
                    <div id="multiHeatmapContainer"></div>
                    <div class="buttons">
                        <button onclick="window.print()">Print PDF</button>
                        <button onclick="tracker.exportToCSV()">Export CSV</button>
                        <button onclick="location.reload()">Clear Session</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Exercise Log</h2>
                <div class="exercise-list" id="exerciseList"></div>
            </div>
        </div>

        <input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="handleFileImport(event)">
    </div>

    <script>
        class ExerciseTracker {
            constructor() {
                this.exercises = [];
                this.exerciseTypes = ['cycling', 'gym', 'squash', 'running', 'pilates', 'swimming'];
                this.setDefaultDate();
            }

            setDefaultDate() {
                document.getElementById('exerciseDate').value = new Date().toISOString().split('T')[0];
            }

            startFresh() {
                document.getElementById('uploadPrompt').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                this.updateDisplay();
            }

            addExercise() {
                const date = document.getElementById('exerciseDate').value;
                const type = document.getElementById('exerciseTypeSelect').value;
                const duration = parseInt(document.getElementById('exerciseDuration').value);
                const notes = document.getElementById('exerciseNotes').value.trim();

                if (!date || !type || !duration) return alert('Fill required fields');

                this.exercises.unshift({ id: Date.now(), date, exercise_type: type, duration_minutes: duration, notes });
                this.updateDisplay();
                document.getElementById('exerciseDuration').value = '';
                document.getElementById('exerciseNotes').value = '';
            }

            addExerciseType() {
                const val = document.getElementById('newExerciseType').value.trim().toLowerCase();
                if (val && !this.exerciseTypes.includes(val)) {
                    this.exerciseTypes.push(val);
                    this.updateDisplay();
                    document.getElementById('newExerciseType').value = '';
                }
            }

            deleteExerciseType(type) {
                if (this.exercises.some(ex => ex.exercise_type === type)) return alert('In use');
                this.exerciseTypes = this.exerciseTypes.filter(t => t !== type);
                this.updateDisplay();
            }

            deleteExercise(id) {
                if (confirm('Delete?')) {
                    this.exercises = this.exercises.filter(ex => ex.id !== id);
                    this.updateDisplay();
                }
            }

            formatExerciseLine(date, type, duration) {
                const fmtDate = new Date(date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                const base = `${fmtDate} ${type} ${duration} min`;
                const dashes = '-'.repeat(Math.max(5, 60 - base.length));
                return `${fmtDate} ${type} ${dashes} ${duration} min`;
            }

            updateDisplay() {
                this.updateTypeUI();
                this.updateLogUI();
                this.updateSummaryUI();
            }

            updateTypeUI() {
                const sel = document.getElementById('exerciseTypeSelect');
                const cur = sel.value;
                sel.innerHTML = '<option value="">Select...</option>' + 
                    this.exerciseTypes.sort().map(t => `<option value="${t}">${t}</option>`).join('');
                if (this.exerciseTypes.includes(cur)) sel.value = cur;
                document.getElementById('exerciseTypeList').innerHTML = this.exerciseTypes.sort().map(t => `
                    <div class="exercise-type-item"><span>${t}</span><button onclick="tracker.deleteExerciseType('${t}')">Del</button></div>
                `).join('');
            }

            updateLogUI() {
                const sorted = [...this.exercises].sort((a,b) => new Date(b.date) - new Date(a.date));
                document.getElementById('exerciseList').innerHTML = sorted.map(ex => `
                    <div class="exercise-entry">
                        <div class="exercise-main">
                            <div class="exercise-text">${this.formatExerciseLine(ex.date, ex.exercise_type, ex.duration_minutes)}</div>
                            <button class="delete-btn" onclick="tracker.deleteExercise(${ex.id})">Del</button>
                        </div>
                        ${ex.notes ? `<div class="exercise-notes">${ex.notes}</div>` : ''}
                    </div>
                `).join('') || '<div class="no-exercises">Empty session.</div>';
            }

            updateSummaryUI() {
                const stats = this.exercises.reduce((acc, ex) => {
                    if (!acc[ex.exercise_type]) acc[ex.exercise_type] = { count: 0, min: 0 };
                    acc[ex.exercise_type].count++;
                    acc[ex.exercise_type].min += ex.duration_minutes;
                    return acc;
                }, {});

                const lines = Object.entries(stats).sort((a,b) => b[1].min - a[1].min).map(([t, d]) => 
                    `<div class="summary-line">${t} ------------------- ${d.count} sessions, ${d.min} min</div>`
                ).join('');

                document.getElementById('summaryContent').innerHTML = `
                    <div class="summary-subtitle">Overall Session Stats</div>
                    ${lines || 'No session data.'}
                `;
                this.renderHeatmaps();
            }

            renderHeatmaps() {
                const container = document.getElementById('multiHeatmapContainer');
                container.innerHTML = '';
                const years = [...new Set(this.exercises.map(ex => new Date(ex.date).getFullYear()))].sort((a, b) => b - a);
                if (years.length === 0) years.push(new Date().getFullYear());

                years.forEach(year => {
                    const label = document.createElement('div');
                    label.className = 'heatmap-year-label';
                    label.innerText = `Year: ${year}`;
                    const grid = document.createElement('div');
                    grid.className = 'heatmap-grid';
                    grid.innerHTML = this.generateYearGrid(year);
                    container.appendChild(label);
                    container.appendChild(grid);
                });
            }

            generateYearGrid(year) {
                const daily = this.exercises.reduce((acc, ex) => {
                    acc[ex.date] = (acc[ex.date] || 0) + ex.duration_minutes;
                    return acc;
                }, {});
                let html = '';
                for(let m=0; m<12; m++) {
                    for(let d=1; d<=31; d++) {
                        const dt = new Date(year, m, d);
                        if(dt.getMonth() !== m) { html += '<div class="heatmap-cell level-0"></div>'; continue; }
                        const str = `${year}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        const mins = daily[str] || 0;
                        const lvl = mins === 0 ? 0 : mins <= 30 ? 1 : mins <= 60 ? 2 : mins <= 120 ? 3 : 4;
                        html += `<div class="heatmap-cell level-${lvl}" title="${str}: ${mins}min"></div>`;
                    }
                }
                return html;
            }

            importCSV(csv) {
                const lines = csv.trim().split('\n');
                if (lines.length < 2) return;
                const headers = lines[0].toLowerCase().split(',').map(h => h.trim());
                this.exercises = lines.slice(1).map(l => {
                    const v = this.parseCSVLine(l);
                    const type = v[headers.indexOf('exercise_type')];
                    if (type && !this.exerciseTypes.includes(type)) this.exerciseTypes.push(type);
                    return {
                        id: Date.now() + Math.random(),
                        date: v[headers.indexOf('date')],
                        exercise_type: type,
                        duration_minutes: parseInt(v[headers.indexOf('duration_minutes')]),
                        notes: (v[headers.indexOf('notes')] || '').replace(/^"|"$/g, '')
                    };
                }).filter(ex => ex.date);
                this.startFresh();
            }

            parseCSVLine(l) {
                const r = []; let c = '', q = false;
                for(let char of l) {
                    if(char === '"') q = !q;
                    else if(char === ',' && !q) { r.push(c); c = ''; }
                    else c += char;
                }
                r.push(c); return r;
            }

            exportToCSV() {
                const h = 'date,exercise_type,duration_minutes,notes';
                const r = this.exercises.map(ex => `${ex.date},${ex.exercise_type},${ex.duration_minutes},"${ex.notes.replace(/"/g, '""')}"`);
                const blob = new Blob([[h, ...r].join('\n')], { type: 'text/csv' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `workout_history_export.csv`;
                a.click();
            }
        }

        // GLOBAL DEFINITIONS
        const tracker = new ExerciseTracker();

        function handleFileImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => tracker.importCSV(evt.target.result);
            reader.readAsText(file);
        }
    </script>
</body></html>
